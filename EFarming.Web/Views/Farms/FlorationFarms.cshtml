@model List<EFarming.Core.FarmModule.FarmAggregate.Farm>

@{
	ViewBag.Title = "GeopositionFarms";
	//Layout = "~/Views/Shared/_layout_without_menu.cshtml";

	var jss = new System.Web.Script.Serialization.JavaScriptSerializer();
	var farmJson = jss.Serialize(ViewBag.o_farm);

}

<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />
<div class="row">
    <div class="ibox-title">
        <div class="row">
            <div class="col-lg-2 col-md-2 col-sm-2">
                <h5>Mapa</h5>
            </div>
            <div class="col-lg-9 col-md-9 col-sm-9"></div>
            <div class="col-lg-1 col-md-1 col-sm-1">
                
            </div>
        </div>
    </div>
    <div class="ibox-content">
        <div class="flot-chart farm-search">
            <div class="row">
				<div class="col-lg-2 text-center">
					<label>Código finca</label>
					@Html.TextBox("txtByCode", null, new { @placeholder = "CODE", @class = "form-control" , @id = "code" })
				</div>
                <div class="col-lg-2">
                    <label>Nombre finca</label>
                    @Html.TextBox("txtSearch", null, new { @placeholder = "Search a Farm",@class = "form-control" , @id= "Name" })
                </div>
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <label>Estado</label>
                    <select id="Status" class="form-control">
                        <option value="">Todas</option>
                        @foreach (var Sta in ViewBag.Status)
                        {
                            <option value="@Sta.Id">@Sta.Name</option>

                        }
                    </select>
                </div>
				<div class="col-lg-2 col-md-2 col-sm-2">
					<label>Municipio</label>
					<select id="Municipality" class="form-control">
						<option value="">Todos</option>
						@foreach (var Mun in ViewBag.Municipality)
						{
							<option value="@Mun.Id">@Mun.Name</option>

						}
					</select>
				</div>
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <label>Vereda</label>
					<select id="idVillage" class="form-control select2">
						<option value="">Todos</option>
						@*@foreach (var Village in ViewBag.villages) {
							<option value="@Village.Id">@Village.Name</option>

						}*@
					</select>
                </div>
            </div>
            <hr />
            <div class="row">
                <div class="col-md-2">
                    <label> Inicio</label>
                    <input type="text" name="Dstart" id="Dstart" value="@ViewBag.FInicio" class="form-control date" />
                </div>
                <div class="col-md-2">
                    <label> Fin</label>
                    <input type="text" name="DEnd" id="DEnd" value="@ViewBag.Ffin" class="form-control date" />
                </div>
                <div class="col-md-1 col-lg-1">
                    <label>Buscar</label>
                    <input action="action" class="btn btn-success" type="button" id="searchFloration" value="Buscar" />
                </div>
            </div>
            <hr />
        </div>
        <div class="flot-chart farm-search">
            <div class="row">
                @*<div class="col-lg-2 col-md-2 col-sm-2">

                    <div id="myData" style="width:auto; height:500px; overflow-y: scroll;">
                        <table class="table">
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <p>@item.Code - @item.Name</p>
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>*@
                <div class="col-lg-10 col-md-10 col-sm-12 col-md-offset-1 col-lg-offset-1 " >
                    <div id="googleMap" style="width:auto;height:600px;"></div>
                </div>
            </div>
            @*Esta tabla no utilizarla por el momento*@
            @*<div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12">
                        <table class="table table-responsive table-condensed">
                            <thead>
                                <tr>
                                    <td>Code</td>
                                    <td>Farm</td>
                                    <td>Latitude</td>
                                    <td>Longitude</td>
                                    <td>Elevation</td>
                                </tr>
                            </thead>
                            @if (Model != null)
                            {
                                foreach (var farm in Model)
                                {
                                    <tr>
                                        <td>@farm.Code</td>
                                        <td>@farm.Name</td>
                                        <td>@farm.GeoLocation.Latitude</td>
                                        <td>@farm.GeoLocation.Longitude</td>
                                        <td>@farm.GeoLocation.Elevation</td>
                                    </tr>
                                }
                            }
                        </table>
                    </div>
                </div>*@
        </div>
    </div>
</div>


@section Scripts{


	<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCjHGiLnMTX2976ZXNk_A2AjiWGSZyAyZ4&sensor=false"></script>
	@*<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=false"></script>*@
	<script src="~/Scripts/jquery-ui-1.11.1.js"></script>
	<script type="text/javascript">
		//$(".select2").select2({ placeholder: "Select" });
		$(".date").datepicker({ dateFormat: 'yy-mm-dd' });
		var o_farm = JSON.parse('@Html.Raw(farmJson)');


        $(document).ready(function () {
			var gmarkers = [];
			var map;

			function initialize() {
				var mapProp = {
					center: new google.maps.LatLng(2.19822, -75.63593), // Start in the
						zoom: 8,
						mapTypeId: google.maps.MapTypeId.SATELLITE

					};
				map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
				FillPositionsInMap(o_farm);
			}


			google.maps.event.addDomListener(window, 'load', initialize);

            // Seach the floration for a several filters
            // El boton del departamento seleccionado
			$(document).on('click',"#searchFloration",function () {
					var x = this.id;
					console.log(x);


					for (i = 0; i < gmarkers.length; i++) {
						gmarkers[i].setMap(null);
					}

					$.ajax({
						type: "POST",
						url: '@Url.Action("SearchFloration", "Farms")', //"../Sustainability/Search"
						//contentType: "application/json; charset=utf-8",
						data: {
							 code: $("#code").val()
							,Name: $("#Name").val()
							, municipality: $("#Municipality").val()
							, idVillage: $("#idVillage").val()
							, Dstart: $("#Dstart").val()
							, DEnd: $("#DEnd").val()
                            , Status: $("#Status").val()
						},
						dataType: "json",
						success: function (data) {
							FillPositionsInMap(data);
						}
					});
			});


            // Seach the floration for a several filters
            // El boton del departamento seleccionado
			$(document).on('change',"#Municipality",function () {
				var s_elm = $(this);
				$.ajax({
					type: "POST",
					url: '@Url.Action("Get_Villages", "Farms")',
					data: {
						Municipality: s_elm.val()
					},
					dataType: "json",
					success: function (data) {
						FillSelectFrom_Json(data, $("#idVillage"))
					}
				});
			});






            // Pinta las respuestas de la peticion AJAX
            // en el mapa de google maps
			function FillPositionsInMap(data) {
				var x;
                var table = "<table class='table'>";
				$.each(data, function (index, value) {
                    //alert(value.Latitude + value.Longitude);
                    table += "<tr><td>" + value.Code + " - " + value.Name + "</td></tr>";
                    var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                    var contentString = '<div><h3>Code NN: ' + value.Code
						+ '</h3><div><p>Farm Name: ' + value.Name
						+ '</p><p > Floration Date: ' + value.StarDate+'</p><p>Cooperative: ' + value.Cooperative.Name + ' Village: ' + value.Vereda

                + '<p><a href="' + value.url_farm + '" target="_blank" class="btn"> Farm Information</a></p>'
                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });
                    var marker = new google.maps.Marker({
                        position: latlng,
                        icon: "../Images/pinkball.png",
                        map: map,
                        title: value.Code,
                    });
                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
					});

					marker.setPosition(latlng);


					gmarkers.push(marker);
					if (index - 1 == data.length) {
						map.center = new google.maps.LatLng(-24.397, 140.644);
					}
				});

                //table += "</table>";
                //$("#myData").html(table);

                //if (x == "") {
                //    for (j = 0; j < gmarkers.length; j++) {
                //        gmarkers[j].setMap(null);
                //    }
                //}
            }
		});


		function FillSelectFrom_Json(object, target) {
			$(target).html("<option value=''>Select</option>");
			$.each(object, function (index, value) {
				$(target).append("<option value='" + value.Id + "'>" + value.Name + "</option>")
			})

		}

	</script>
}
