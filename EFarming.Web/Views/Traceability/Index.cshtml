@{
    ViewBag.Title = @Message.Traceability;
    Layout = "~/Views/Shared/_Layout.cshtml";
    double totalWeight = 0;
    double totalPrice = 0;
}

@section breadcrumb{
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10">
            <h2 class="page-name">@Message.Traceability</h2>
            <ol class="breadcrumb">
                <li>
                    <a href="@Url.Action("Index", "Home")">
                        @Message.Home
                    </a>
                </li>

                <li class="active">
                    <strong>@Message.Traceability</strong>
                </li>
            </ol>
        </div>
        <div class="col-lg-2">
        </div>
    </div>
}

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>@Message.Traceability</h5>
                </div>
                <div class="ibox-content">
                    <div class="flot-chart farm-search">
                        <div class="row">
                            <div class="col-md-12">
                                <form class="form-inline" role="form" method="get" action="/traceability">
                                    <div class="form-group">
                                        <label for="year">@Message.Start_Date</label>
                                        <input type="date" id="start" name="start" class="form-control" value="@ViewBag.SelectedStart" />
                                    </div>
                                    <div class="form-group">
                                        <label for="year">@Message.End_Date</label>
                                        <input type="date" id="end" name="end" class="form-control" value="@ViewBag.SelectedEnd" />
                                    </div>
                                    <div class="form-group">
                                        <label for="year">@TraceabilityMessage.Lot</label>
                                        @Html.DropDownList("lotId", ViewBag.Lots as System.Web.Mvc.SelectList, string.Format(Message.SelectA, TraceabilityMessage.Lot), new { @class = "form-control" })
                                    </div>
                                    <button type="submit" class="btn btn-default">@Message.Search</button>
                                </form>
                            </div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-md-5">
                                <div class="table-responsive">
                                    <h3 class="page-header">@TraceabilityMessage.Sellers</h3>
                                    <table class="table table-condensed table-striped">
                                        <thead>
                                            <tr>
                                                <th>@FarmMessages.Farm</th>
                                                <th>@TraceabilityMessage.Weight (Kg)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var invoice in (IEnumerable<EFarming.Common.SharedClasses.GroupedInvoice>)ViewBag.TopSellers)
                                            {
                                                totalWeight += invoice.Weight;
                                                totalPrice += invoice.Price;
                                                <tr>
                                                    <td>@invoice.Farm</td>					  
                                                    <td>@string.Format("{0:0,0.##}", invoice.Weight)</td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <th>@Message.Total</th>
                                                <th>@string.Format("{0:0,0.##}", totalWeight)</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <h3 class="page-header">@TraceabilityMessage.Sales</h3>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div id="weight-chart-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="~/Scripts/highcharts/highcharts.js"></script>
    <script src="~/Scripts/highcharts/highcharts-more.js"></script>
    <script src="~/Scripts/highcharts/solid-gauge.src.js"></script>
    <script src="~/Scripts/highcharts/exporting.js"></script>
}

<script type="text/javascript">
    var start = '@ViewBag.SelectedStart';
    var end = '@ViewBag.SelectedEnd';
    var lotid = '@ViewBag.SeletedLotId';
    $(function () {
        var url = '/api/dashboard/InvoicesByLocation?start=' + start + "&end=" + end + "&lotId=" + lotid;
        $.get(url, function (data) {
            $('#weight-chart-container').highcharts({
                chart: {
                    type: 'column'
                },
                title: {
                    text: data[0].Title
                },
                xAxis: {
                    categories: data[0].Categories,
                    type: 'category',
                    labels: {
                        rotation: -45,
                        style: {
                            fontSize: '13px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: data[0].YTitle
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y:.1f} kg</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0
                    }
                },
                series: data[0].Items
            });

            $('#price-chart-container').highcharts({
                chart: {
                    type: 'column'
                },
                title: {
                    text: data[1].Title
                },
                xAxis: {
                    categories: data[1].Categories,
                    type: 'category',
                    labels: {
                        rotation: -45,
                        style: {
                            fontSize: '13px',
                            fontFamily: 'Verdana, sans-serif'
                        }
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: data[1].YTitle
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0
                    }
                },
                series: data[1].Items
            });
        });
    });
</script>