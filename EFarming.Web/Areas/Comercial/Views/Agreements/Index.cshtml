@model IEnumerable<EFarming.Core.ComercialModule.Agreement>
@using EFarming.Core.ComercialModule;

@{
    ViewBag.Title = "Contracts list";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var imagePath = Server.MapPath("~/Images");
}

<link href="~/Content/themes/base/all.css" rel="stylesheet" />

@Html.Partial("~/Areas/Comercial/Views/Shared/_Navegation_Comercial.cshtml")
<br />
<div class="col-md-12">

    <div class="col-md-12">
        <div class="row wrapper border-bottom white-bg page-heading">
            <div class="row">
                <div style="margin-left:10px">                    
                    <div div class="col-md-12 text-center" style="margin-top:15px">
                        <form class="form-inline" role="form" method="get" action="/Comercial/Agreements/Index">
                            <div class="form-group">
			  <label > Filter by ShipmentDate:   </label>
                                <label for="year">From:</label>
                                <input type="date" id="start" name="start" class="form-control" value="@string.Format("{0:dd/MM/yyyy}", ViewBag.SelectedStart)" />
                            </div>
                            <div class="form-group">
                                <label for="year">To: </label>
                                <input type="date" id="end" name="end" class="form-control" value="@string.Format("{0:dd/MM/yyyy}", ViewBag.SelectedEnd)" />
                            </div>
                            <button type="submit" class="btn btn-default">Search</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@using (Html.BeginForm("Create", "ContractLots", FormMethod.Get, new { enctype = "multipart/form-data" }))
{
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <div class="panel panel-primary filterable">
                    <div class="panel-heading" style="background-color :aliceblue">
                        <h3 class="panel-title">Contracts</h3>
                        <div class="pull-right">
                            <label class="btn btn-success btn-xs btn-filter"><span class="glyphicon glyphicon-filter"></span> Filter</label>                            
                        </div>
                    </div>                    
                    <table class="table table-fixed-header">
                        <thead>
                            <tr class="filters">
                                <th><input class="btn btn-success btn-xs" type="submit" value="Create Lots" /></th>
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.Client.Name)" disabled></th>
                                @*<th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.Seller.Name)" disabled></th>*@
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.OurRef)" disabled></th>
                                <!-- SE CAMBIA EL LABEL POR SOLICITUD DE JHONNATAN -->
                                @*<th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.Date)" disabled></th>*@
                                <th><input type="text" class="form-control" placeholder="Business Date" disabled></th>
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.Volume)" disabled></th>
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.ShipmentDate)" disabled></th>
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.Quality)" disabled></th>
                                @*<th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.LotsNumber)" disabled></th>*@
                                @*<th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.PriceDate)" disabled></th>*@
                                <th><input type="text" class="form-control" placeholder="@Html.DisplayNameFor(model => model.PriceDifferential)" disabled></th>
                                <th><span>PDF</span></th>
                                <th><span class="glyphicon glyphicon-cog"></span></th>
                            </tr>
                        </thead>

                        @foreach (var item in Model)
                        {
                            string ShortName = "";
                            List<MoreInformation> List = ViewBag.QualityList;
                            IEnumerable<MoreInformation> shortNameList = List.Where(x => x.Text.Equals(item.Quality) && x.ClientId.Equals(item.ClientId));
                            ShortName = shortNameList.First().Short.ToString();
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="ContractsForLots" value="@item.Id" />
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Client.Name)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.OurRef)
                                </td>
                                <td>
                                    @string.Format("{0:dd/MM/yyyy}", item.Date)
                                </td>
                                <td>
                                    @Html.DisplayFor(modelItem => item.Volume)
                                </td>
                                <td>
                                    @string.Format("{0:dd/MM/yyyy}", item.ShipmentDate)
                                </td>
                                <td>
                                    <small>
                                        @ShortName
                                    </small>
                                </td>
                                <td>
                                    <span class="label"></span> @Html.DisplayFor(modelItem => item.PriceDifferential)
                                </td>
                                <td>
                                    <a target="_blank" href="@Url.Action("Details", new { id = item.Id })"><img src="~/Images/Adobe_icon_32x32.png" alt="Details" /></a>
                                </td>
                                <td>
                                    <div class="row">
                                        <div class="col-lg-12 col-md-12 col-sm-12">
                                            <a href="@Url.Action("Edit", new { id = item.Id })"><span class="glyphicon glyphicon-edit"></span></a>
                                            <a onclick="return confirm('Are you sure to delete the @item.OurRef Contract?')" href="@Url.Action("Delete", new { id = item.Id })"><span class="glyphicon glyphicon-remove"></span></a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<style>
          .filterable {
              margin-top: 15px;
          }

              .filterable .panel-heading .pull-right {
                  margin-top: -20px;
              }

              .filterable .filters input[disabled] {
                  background-color: transparent;
                  border: none;
                  cursor: auto;
                  box-shadow: none;
                  padding: 0;
                  height: auto;
              }

                  .filterable .filters input[disabled]::-webkit-input-placeholder {
                      color: #333;
                  }

                  .filterable .filters input[disabled]::-moz-placeholder {
                      color: #333;
                  }

                  .filterable .filters input[disabled]:-ms-input-placeholder {
                      color: #333;
                  }

          table .header-fixed {
              position: fixed;
              top: 40px;
              z-index: 1020; /* 10 less than .navbar-fixed to prevent any overlap */
              border-bottom: 1px solid #d5d5d5;
              -webkit-border-radius: 0;
              -moz-border-radius: 0;
              border-radius: 0;
              -webkit-box-shadow: inset 0 1px 0 #fff, 0 1px 5px rgba(0,0,0,.1);
              -moz-box-shadow: inset 0 1px 0 #fff, 0 1px 5px rgba(0,0,0,.1);
              box-shadow: inset 0 1px 0 #fff, 0 1px 5px rgba(0,0,0,.1);
              filter: progid:DXImageTransform.Microsoft.gradient(enabled=false); /* IE6-9 */
          }
</style>

<script src="~/Scripts/jquery-ui-1.10.4.min.js"></script>
<script type="text/javascript">

    var startDate = "@ViewBag.SelectedStart.ToString("yyyy-MM-dd")";
    var endDate = "@ViewBag.SelectedEnd.ToString("yyyy-MM-dd")";

    $("#start").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        beforeShow: function (input, inst) {
            var rect = input.getBoundingClientRect();
            setTimeout(function () {
                inst.dpDiv.css({ top: rect.top + 40, left: rect.left + 0 });
            }, 0);
        }
    });

    $("#end").datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: "yy-mm-dd",
        beforeShow: function (input, inst) {
            var rect = input.getBoundingClientRect();
            setTimeout(function () {
                inst.dpDiv.css({ top: rect.top + 40, left: rect.left + 0 });
            }, 0);
        }
    });
</script>

@section Scripts{
    <script type="text/javascript">
        $(document).ready(function () {
            $('.filterable .btn-filter').click(function () {
                var $panel = $(this).parents('.filterable'),
	      $filters = $panel.find('.filters input'),
	      $tbody = $panel.find('.table tbody');
                if ($filters.prop('disabled') == true) {
                    $filters.prop('disabled', false);
                    $filters.first().focus();
                } else {
                    $filters.val('').prop('disabled', true);
                    $tbody.find('.no-result').remove();
                    $tbody.find('tr').show();
                }
            });

            $('.filterable .filters input').keyup(function (e) {
                /* Ignore tab key */
                var code = e.keyCode || e.which;
                if (code == '9') return;
                /* Useful DOM data and selectors */
                var $input = $(this),
	      inputContent = $input.val().toLowerCase(),
	      $panel = $input.parents('.filterable'),
	      column = $panel.find('.filters th').index($input.parents('th')),
	      $table = $panel.find('.table'),
	      $rows = $table.find('tbody tr');
                /* Dirtiest filter function ever ;) */
                var $filteredRows = $rows.filter(function () {
                    var value = $(this).find('td').eq(column).text().toLowerCase();
                    return value.indexOf(inputContent) === -1;
                });
                /* Clean previous no-result if exist */
                $table.find('tbody .no-result').remove();
                /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
                $rows.show();
                $filteredRows.hide();
                /* Prepend no-result row if all rows are filtered */
                if ($filteredRows.length === $rows.length) {
                    $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="' + $table.find('.filters th').length + '">No result found</td></tr>'));
                }
            });
        });

        (function ($) {

            $.fn.fixedHeader = function (options) {
                var config = {
                    topOffset: 40,
                    bgColor: '#EEEEEE'
                };
                if (options) { $.extend(config, options); }

                return this.each(function () {
                    var o = $(this);

                    var $win = $(window)
		  , $head = $('thead.header', o)
		  , isFixed = 0;
                    var headTop = $head.length && $head.offset().top - config.topOffset;

                    function processScroll() {
                        if (!o.is(':visible')) return;
                        var i, scrollTop = $win.scrollTop();
                        var t = $head.length && $head.offset().top - config.topOffset;
                        if (!isFixed && headTop != t) { headTop = t; }
                        if (scrollTop >= headTop && !isFixed) { isFixed = 1; }
                        else if (scrollTop <= headTop && isFixed) { isFixed = 0; }
                        isFixed ? $('thead.header-copy', o).removeClass('hide')
			  : $('thead.header-copy', o).addClass('hide');
                    }
                    $win.on('scroll', processScroll);

                    // hack sad times - holdover until rewrite for 2.1
                    $head.on('click', function () {
                        if (!isFixed) setTimeout(function () { $win.scrollTop($win.scrollTop() - 47) }, 10);
                    })

                    $head.clone().removeClass('header').addClass('header-copy header-fixed').appendTo(o);
                    var ww = [];
                    o.find('thead.header > tr:first > th').each(function (i, h) {
                        ww.push($(h).width());
                    });
                    $.each(ww, function (i, w) {
                        o.find('thead.header > tr > th:eq(' + i + '), thead.header-copy > tr > th:eq(' + i + ')').css({ width: w });
                    });

                    o.find('thead.header-copy').css({
                        margin: '0 auto',
                        width: o.width(),
                        'background-color': config.bgColor
                    });
                    processScroll();
                });
            };
        })(jQuery);
    </script>
}
